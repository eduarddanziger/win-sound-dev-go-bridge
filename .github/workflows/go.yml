# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  push:
    tags:
      - v*
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: windows-2022
    permissions:
      contents: read
      packages: write
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}
      VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"

      - name: Compute app version
        shell: powershell
        run: |
          $version = "${{ env.VERSION }}"
          if (-not $version) {
            $version = "dev"
          }
          if ($version.StartsWith("v")) {
            $version = $version.Substring(1)
          }
          Write-Host "Computed APP_VERSION=$version"
          "APP_VERSION=$version" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build Go binary (CGO, Windows)
        shell: powershell
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
        run: |
          $Env:CGO_ENABLED = "1"

          # Use MSVC toolchain available on windows-2022 instead of a hardcoded llvm-mingw path.
          # Load the Visual Studio environment (this sets up cl.exe and related vars for 64-bit build).
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" amd64

          New-Item -ItemType Directory -Force -Path (Join-Path $PWD "bin") | Out-Null

          $ldflags = "-X github.com/eduarddanziger/win-sound-dev-go-bridge/pkg/appinfo.Version=$Env:APP_VERSION"
          go build -ldflags $ldflags -o (Join-Path $PWD.Path 'bin/')

      - name: Run fetch-native script
        shell: powershell
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          Write-Host "Running fetch-native.ps1 for $Env:GITHUB_REPOSITORY@$Env:GITHUB_REF_NAME (sha $Env:GITHUB_SHA, run $Env:GITHUB_RUN_ID) with APP_VERSION=$Env:APP_VERSION"
          .\scripts\fetch-native.ps1 -DllOutSubDir "bin"

      - name: Rebuild Go binary after native fetch
        shell: powershell
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
        run: |
          $Env:CGO_ENABLED = "1"

          # Re-load MSVC environment for final build.
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" amd64

          New-Item -ItemType Directory -Force -Path (Join-Path $PWD "bin") | Out-Null

          $ldflags = "-X github.com/eduarddanziger/win-sound-dev-go-bridge/pkg/appinfo.Version=$Env:APP_VERSION"
          go build -ldflags $ldflags -o (Join-Path $PWD.Path 'bin/')

      - name: Package bin directory
        shell: powershell
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
        run: |
          $artifactName = "go-bridge-$Env:APP_VERSION.zip"
          Write-Host "Creating artifact $artifactName from bin/ ..."
          if (-not (Test-Path -Path (Join-Path $PWD "bin"))) {
            throw "bin directory not found; nothing to package."
          }
          Compress-Archive -Path (Join-Path $PWD "bin" '*') -DestinationPath (Join-Path $PWD $artifactName) -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
        with:
          name: go-bridge-${{ env.APP_VERSION }}
          path: go-bridge-${{ env.APP_VERSION }}.zip
          if-no-files-found: error
