# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  push:
    tags:
      - v*
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: windows-2022
    permissions:
      contents: read
      packages: write
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}
      VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"

      - name: Compute app version
        shell: powershell
        run: |
          $version = "${{ env.VERSION }}"
          if (-not $version) {
            $version = "dev"
          }
          if ($version.StartsWith("v")) {
            $version = $version.Substring(1)
          }
          Write-Host "Computed APP_VERSION=$version"
          "APP_VERSION=$version" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install llvm-mingw (clang toolchain for CGO)
        shell: powershell
        run: |
          # NOTE: keep this in sync with a real llvm-mingw release tag
          $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/20240619/llvm-mingw-20240619-msvcrt-x86_64.zip"
          $zip = Join-Path $Env:TEMP "llvm-mingw.zip"
          $destRoot = "C:\tools"
          $dest = Join-Path $destRoot "llvm-mingw"

          New-Item -ItemType Directory -Force -Path $destRoot | Out-Null
          New-Item -ItemType Directory -Force -Path $dest | Out-Null

          Write-Host "Downloading llvm-mingw from $url ..."
          Invoke-WebRequest -Uri $url -OutFile $zip -UseBasicParsing

          Write-Host "Extracting to $dest ..."
          Expand-Archive -Path $zip -DestinationPath $dest -Force

          # The archive usually unpacks into a subfolder; move contents up if needed
          $inner = Get-ChildItem -Path $dest | Where-Object { $_.PSIsContainer } | Select-Object -First 1
          if ($inner) {
            Write-Host "Flattening $($inner.FullName) into $dest ..."
            Get-ChildItem -Path $inner.FullName | Move-Item -Destination $dest -Force
            Remove-Item -Recurse -Force $inner.FullName
          }

          Remove-Item $zip -Force

          Write-Host "llvm-mingw installed under $dest"

      - name: Build Go binary (CGO, Windows) first time, compiler errors ignored
        shell: powershell
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
        run: |
          $Env:CGO_ENABLED = "1"
          $Env:CC  = "C:\tools\llvm-mingw\bin\x86_64-w64-mingw32-clang.exe"
          $Env:CXX = "C:\tools\llvm-mingw\bin\x86_64-w64-mingw32-clang++.exe"

          New-Item -ItemType Directory -Force -Path (Join-Path $PWD "bin") | Out-Null

          $ldflags = "-X github.com/eduarddanziger/win-sound-dev-go-bridge/pkg/appinfo.Version=$Env:APP_VERSION"
          Write-Host "[non-fatal] Running initial go build with CGO..."
          go build -ldflags $ldflags -o (Join-Path $PWD.Path 'bin/')
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "Initial go build failed with exit code $LASTEXITCODE; continuing pipeline as fetch-native and final build may still succeed."
            # Reset exit code to avoid failing the step
            $global:LASTEXITCODE = 0
          }

      - name: Run fetch-native script
        shell: powershell
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          Write-Host "Running fetch-native.ps1 for $Env:GITHUB_REPOSITORY@$Env:GITHUB_REF_NAME (sha $Env:GITHUB_SHA, run $Env:GITHUB_RUN_ID) with APP_VERSION=$Env:APP_VERSION"
          .\scripts\fetch-native.ps1 -DllOutSubDir "bin"

      - name: Rebuild Go binary after native fetch
        shell: powershell
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
        run: |
          $Env:CGO_ENABLED = "1"
          $Env:CC  = "C:\tools\llvm-mingw\bin\x86_64-w64-mingw32-clang.exe"
          $Env:CXX = "C:\tools\llvm-mingw\bin\x86_64-w64-mingw32-clang++.exe"

          New-Item -ItemType Directory -Force -Path (Join-Path $PWD "bin") | Out-Null

          $ldflags = "-X github.com/eduarddanziger/win-sound-dev-go-bridge/pkg/appinfo.Version=$Env:APP_VERSION"
          go build -ldflags $ldflags -o (Join-Path $PWD.Path 'bin/')

      - name: Package bin directory
        shell: powershell
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
        run: |
          $artifactName = "go-bridge-$Env:APP_VERSION.zip"
          Write-Host "Creating artifact $artifactName from bin/ ..."
          $binPath = Join-Path $PWD "bin"
          if (-not (Test-Path -Path $binPath)) {
            throw "bin directory not found; nothing to package."
          }
          $binGlob = Join-Path $binPath "*"
          Compress-Archive -Path $binGlob -DestinationPath (Join-Path $PWD $artifactName) -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        env:
          APP_VERSION: ${{ env.APP_VERSION }}
        with:
          name: go-bridge-${{ env.APP_VERSION }}
          path: go-bridge-${{ env.APP_VERSION }}.zip
          if-no-files-found: error
